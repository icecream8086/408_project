# 多重中断与中断屏蔽技术

## 摘要

本笔记系统解析多重中断机制与中断屏蔽技术，重点阐述中断屏蔽字的动态优先级调控原理。通过结构化呈现核心概念、数学表达和典型应用场景，建立中断处理流程的完整认知框架。

---

## 主题

中断系统的多级响应机制设计，涵盖：

- 中断嵌套实现原理
- 中断屏蔽字位图调控技术
- 中断向量与硬件交互逻辑

> 重点难点
>
> - **开中断指令**的插入时机与现场保护机制
> - 中断屏蔽字**位图权重**与优先级动态映射
> - NMI（Non-Maskable Interrupt）与可屏蔽中断的硬件实现差异

---

## 线索区

### 1. 多重中断实现机制

**定义**：允许高优先级中断打断正在执行的低优先级中断服务程序（ISR）  
**核心方法**：

1. **开中断策略**：在 ISR 起始阶段插入`STI`指令（x86 架构）
2. **现场保护**：通过堆栈保存 PSW（程序状态字）和 PC 值
3. **原子化恢复**：在恢复现场前执行`CLI`指令确保操作连贯性

**电路特征**：

```text
         +---------------+
         | 高优先级IRQ  |----+
         +---------------+   |
                  |          v
+------+      +-------+    +-----+
| 主程序 |--->| ISR入口 |-->| STI |-->[可被中断]
+------+      +-------+    +-----+
```

---

### 2. 中断屏蔽字技术

**数学表达**：  
设 n 位屏蔽字为$M = (m_{n-1},...,m_0)$，中断请求向量为$R = (r_{n-1},...,r_0)$  
有效中断请求：$E = R \land \neg M$

**关键参数**：

- **屏蔽粒度**：每个中断源对应独立屏蔽位
- **动态调整**：通过改写**IMR**（中断屏蔽寄存器）实现优先级重构

**典型配置**（4 级中断系统）：  

| 中断源 | 默认优先级 | 屏蔽字模式 |  
|--------|------------|------------|  
| IRQ0 | 最高 | 0b0000 |  
| IRQ1 | 次高 | 0b1000 |  
| IRQ2 | 中 | 0b1100 |  
| IRQ3 | 最低 | 0b1110 |

> **现实类比**：医院急诊分级制度，高优先级患者可中断当前诊疗过程

---

### 3. 硬件实现案例

**8086 CPU 架构**：

- **IF 标志**：位于 FLAGS 寄存器第 9 位，控制可屏蔽中断
- **NMI 引脚**：边沿触发，不受 IF 位影响
- **8259A PIC**：实现 8 级中断优先级控制

**时序流程**：

```text
[中断请求] -> [判优电路] -> [发送INTR] -> [CPU发INTA]
-> [接收向量号] -> [压栈现场] -> [执行ISR]
```

---

## 总结区

**核心考点**：

1. 中断屏蔽字位模式计算（重点考察**位操作**与**优先级映射**）
2. 多重中断现场保护时序（注意**CLI/STI 指令**插入位置）
3. NMI 与常规中断的硬件差异（**IF 标志影响范围**）

**典型题型**：

- 给定中断处理序列，推导屏蔽字配置方案
- 分析中断嵌套时的堆栈变化情况
- 对比单重中断与多重中断的 PSW 处理差异

**优化方向**：

- 采用**硬件优先级解码器**降低中断响应延迟
- 通过**多级中断控制器**扩展中断源数量

---

请确认是否需要深化某个知识点的技术细节或补充典型例题解析。
