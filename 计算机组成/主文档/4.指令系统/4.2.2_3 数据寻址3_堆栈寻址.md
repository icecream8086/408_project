# 堆栈寻址与数据寻址方式

## 摘要

本讲通过堆栈结构的操作特性分析，阐述了硬/软堆栈实现差异及其在函数调用中的应用，对比了 10 种数据寻址方式的特点，重点解析 SP 寄存器动态寻址机制。

## 主题

堆栈的 LIFO 特性与存储器层次实现方案，SP 寄存器动态寻址原理，数据寻址方式分类及应用场景。

> 重点难点
>
> - **堆栈指针(SP)的动态更新逻辑**：PUSH/POP 操作与地址计算关系
> - **访存次数差异量化**：硬堆栈(0 次) vs 软堆栈(2 次/操作)
> - **寻址方式映射关系**：立即寻址 → 常数操作，寄存器间接 → 指针访问

---

## 线索区

### 堆栈基本结构

**定义**：遵循 LIFO 原则的线性数据结构（Last In First Out）  
**核心组件**：

- 栈顶指针 SP(Stack Pointer)：存储当前操作地址（**物理实现**：专用寄存器）
- 栈区：存储单元集合（**实现层级**：寄存器组或内存区域）

**操作特性**：

$$
\begin{cases}
\text{PUSH: } SP \leftarrow SP - \Delta & \Delta=\text{操作数宽度} \\
\text{POP: } SP \leftarrow SP + \Delta &
\end{cases}
$$

---

### 硬堆栈 vs 软堆栈

| 特性     | 硬堆栈                   | 软堆栈                      |
| -------- | ------------------------ | --------------------------- |
| 实现介质 | 寄存器组                 | 主存空间                    |
| 访存次数 | **0**（寄存器直接访问）  | **2 次/操作**（需内存读写） |
| 速度     | 快（ns 级）              | 慢（百 ns 级）              |
| 典型应用 | 早期 RISC 处理器         | x86 等 CISC 架构            |
| 成本     | 高（寄存器占用芯片面积） | 低（复用内存空间）          |

**电路实现差异**：  
硬堆栈采用多路选择器直连寄存器，软堆栈通过内存控制器访问 DRAM

---

### 函数调用中的堆栈应用

**标准过程**：

1. CALL 指令：PUSH 返回地址（PC+4）
2. 参数传递：PUSH 实参寄存器值
3. 局部变量：动态分配栈空间
4. RET 指令：POP 返回地址恢复 PC

**关键参数**：

- **栈帧(stack frame)**：每个函数占用的连续栈空间
- **基址指针(BP)**：记录当前栈帧起始地址

---

### 数据寻址方式对比表

| 寻址方式   | 有效地址计算         | 访存次数 | 典型应用          |
| ---------- | -------------------- | -------- | ----------------- |
| 立即寻址   | 操作数直接包含在指令 | 0        | 常量赋值          |
| 直接寻址   | EA=Addr 字段         | 1        | 全局变量访问      |
| 寄存器间接 | EA=Reg 内容          | 1        | 指针操作          |
| 相对寻址   | EA=PC+Offset         | 1        | 条件跳转          |
| 堆栈寻址   | EA=SP 自动调整       | 0/2      | 函数调用/中断处理 |

---

## 总结区

### 核心考点

1. **SP 更新方向**：注意体系结构差异（x86 堆栈向低地址增长）
2. **访存次数计算**：软堆栈每次操作=1 次读(SP)+1 次写(新 SP)
3. **寻址方式选择**：立即寻址最快（0 访存），直接寻址最灵活

### 典型题型

- 计算不同寻址方式下的指令周期数
- 分析函数调用过程中的堆栈状态变化
- 对比 CISC 与 RISC 的堆栈实现差异

建议通过 EDA 工具（如 Logisim）仿真堆栈操作流程，直观观察 SP 变化与数据流动关系。


[4.3.5_2 如何访问栈帧](4.3.5_2%20如何访问栈帧.md)

[4.3.5_3 如何切换栈帧](4.3.5_3%20如何切换栈帧.md)
