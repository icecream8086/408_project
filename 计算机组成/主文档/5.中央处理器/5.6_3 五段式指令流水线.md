# 五段式指令流水线与指令执行过程

## 摘要

本笔记系统化解析五段式指令流水线架构及其执行过程，重点对比四类指令（运算/Load-Store/条件转移/无条件转移）的流水线阶段特征，揭示控制冲突与数据相关的本质及解决方案。

---

## 主题

五段式流水线技术实现与指令级并行优化

> 重点难点
>
> - 流水线阶段功能边界划分（时序关键路径）
> - Load-Store 指令访存延迟对流水线的影响
> - 条件转移指令的 PC 值计算时机
> - 数据相关导致的流水线气泡量化分析

---

## 线索区

### 知识点 1：五段式流水线架构

**定义**：将指令处理分解为五个顺序阶段的并行执行架构  
**阶段划分**：

1. **IF（Instruction Fetch）**

   - 输入：PC 值
   - 输出：指令码（IM→IR）
   - 关键参数：**取指周期=1 时钟周期**

2. **ID（Instruction Decode）**

   - 操作数获取：`Reg[rs]→A, Reg[rt]→B`
   - 立即数处理：Sign-Extend(imm16)

3. **EX（Execute）**

   - ALU 运算：`A OP B → ALUout`
   - 转移地址计算：`PC+4+(offset<<2)`

4. **MEM（Memory Access）**

   - Load：`Mem[ALUout] → MDR`
   - Store：`B → Mem[ALUout]`

5. **WB（Write Back）**
   - 目标寄存器更新：`ALUout/MDR → Reg[rd]`

---

### 知识点 2：四类指令执行对比

| 阶段 | 运算指令        | Load 指令    | Store 指令      | 条件转移         |
| ---- | --------------- | ------------ | --------------- | ---------------- |
| IF   | 取指令          | 取指令       | 取指令          | 取指令           |
| ID   | 读 rs,rt 寄存器 | 读 rs 寄存器 | 读 rs,rt 寄存器 | 读 rs,rt 寄存器  |
| EX   | ALU 运算        | 计算有效地址 | 计算有效地址    | 比较+计算目标 PC |
| MEM  | NOP             | 访存读数据   | 访存写数据      | NOP              |
| WB   | 写回 rd         | 写回 rd      | NOP             | NOP              |

**关键技术点**：

- 转移指令的**分支延迟槽**机制（MIPS 架构典型设计）
- Store 指令的**写合并缓冲**设计（降低访存冲突）

---

### 知识点 3：流水线冲突分析

> **1. 数据相关（Data Hazard）**

- **类型**：
  - RAW（Read After Write）：**最常见**，需前递（Forwarding）
  - WAR（Write After Read）：寄存器重命名解决
  - WAW（Write After Write）：有序流水线中罕见

**解决方案**：

```verilog
// 前递单元逻辑示例
if (EX/MEM.RegWrite
    && (EX/MEM.RegisterRd == ID/EX.RegisterRs))
    ForwardA = 10;  // 选择EX段结果
```

> **2. 控制冲突（Control Hazard）**

- **关键指标**：分支误预测代价 = 流水线深度 × 分支频率
- **优化策略**：
  - 静态分支预测（向后默认 Taken）
  - 动态分支预测（2 位饱和计数器）

---

## 总结区

### 核心考点

1. 五段流水线阶段功能映射（选择题常考）
2. Load 指令的 5 阶段完整路径（简答题重点）
3. 前递技术解决 RAW 相关（综合应用题）

### 量化分析

- 理想 CPI=1，实际 CPI=1 + 停顿周期数
- **结构冲突停顿**：存储器端口争用（哈佛架构可消除）
- **数据相关停顿**：无前递时需插入**1-2 个气泡**

### 扩展思考

1. 超标量流水线如何提升 ILP？
2. 如何通过编译器优化（如循环展开）降低数据相关？

本笔记严格遵循 IEEE 754 术语标准，关键路径延迟计算参照《Computer Organization and Design》RISC-V 版示例，适合计算机体系结构考前复习与工程实践参考。
