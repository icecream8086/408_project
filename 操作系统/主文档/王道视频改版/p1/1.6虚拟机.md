# 虚拟机管理程序与虚拟化技术（虚拟化技术）

## 摘要

总结虚拟机管理程序（VMM）的核心机制，对比两类 VMM 在特权级管理、资源分配、性能与可迁移性上的差异。通过系统级抽象和实验案例，解析虚拟化技术的实现原理与优化方向。

## 主题

虚拟化技术通过 VMM 将物理资源抽象为多台虚拟机，两类 VMM 分别采用**硬件直通**与**宿主代理**模式。关键差异体现在特权级隔离、资源调度策略和迁移灵活性上。

> **重点难点**
>
> - **特权级穿透**：VMM 如何通过硬件辅助（Intel VT-x）实现特权指令截获
> - **资源映射差异**：第一类 VMM 直接管理物理内存，第二类 VMM 依赖宿主机页表
> - **迁移性权衡**：全虚拟化 vs 半虚拟化对热迁移的影响

## 线索区

### 进程管理/VMM 特权级机制

> **工作机制**

- **Ring 分层**：
  - VMM 运行在**Ring 0**（最高特权级）
  - Guest OS 降级到**Ring 1**（非特权模式）
  - 用户进程运行在**Ring 3**
- **指令截获**：通过**陷入-模拟**机制处理敏感指令（如`HLT`、`INVPLG`）

> **系统调用**

```c
// KVM 创建虚拟机示例（Linux内核接口）
ioctl(vm_fd, KVM_CREATE_VM, 0);
```

> **Linux 命令**

```bash
# 查看CPU虚拟化支持
grep -E 'svm|vmx' /proc/cpuinfo
```

---

### 内存管理/资源分配对比

> **第一类 VMM（Type 1）**

- **物理资源直通**：直接管理内存页表（如 Xen 的`Balloon Driver`）
- **性能优化**：通过**EPT（Extended Page Table）**减少地址转换开销

> **第二类 VMM（Type 2）**

- **宿主机代理**：依赖宿主机`mm_struct`分配虚拟内存（如 VirtualBox 的`VMMDev`）
- **转换层开销**：需经过**宿主机内核态 → 用户态 → 硬件**多层转发

>**性能参数**  

| 指标 | Type 1 VMM | Type 2 VMM |  
|------------|------------|------------|  
| 内存延迟 | **<100ns** | 300-500ns |  
| 最大 vCPU 数 | **1024** | 128 |

---

### 文件系统/虚拟机镜像

> **QCOW2 格式**

- **写时复制**：原始镜像只读，修改写入差异文件（`diff.qcow2`）
- **稀疏存储**：仅分配实际使用的磁盘块

> **操作示例**

```bash
# 创建QCOW2镜像（动态分配）
qemu-img create -f qcow2 vm_disk.qcow2 20G
```

---

## 总结区

1. **核心区别**：

   - Type 1 VMM 直接控制硬件（如 VMware ESXi），**性能优先**
   - Type 2 VMM 依赖宿主机（如 VirtualBox），**灵活性优先**

2. **考点聚焦**：

   - 敏感指令截获实现（硬件辅助 vs 二进制翻译）
   - 内存映射机制差异（EPT vs 影子页表）
   - 热迁移条件（内存脏页率 < **100MB/s**）

3. **实验方向**：

   ```python
   # 用libvirt检测虚拟机状态
   import libvirt
   conn = libvirt.open("qemu:///system")
   print(conn.listDomainsID())  # 输出运行中的虚拟机ID
   ```

---
