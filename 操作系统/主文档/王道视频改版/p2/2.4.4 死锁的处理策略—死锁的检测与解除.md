# 死锁检测与解除 [进程管理/死锁处理]

## 摘要

本课讲解通过资源分配图简化实现死锁检测，以及三种死锁解除方法。核心是通过消除非阻塞进程边判断系统状态，重点掌握检测算法流程和牺牲进程选择标准。考试聚焦资源分配图解析和算法实现。

---

## 主题

通过资源分配图简化判定死锁状态，运用资源剥夺/进程撤销/状态回退解除死锁。关键问题：如何高效检测死锁？解除时如何选择牺牲进程？

> 重点难点
>
> - **资源分配图动态简化**：消除非阻塞进程边的顺序影响检测效率
> - **解除策略权衡**：资源剥夺可能引发级联回滚 vs 进程撤销导致工作丢失
> - **O(n²)检测算法**：需遍历所有进程-资源关系

---

## 线索区

### 知识点 1：资源分配图模型 [内存管理/进程同步]

$$
\begin{array}{ccc}
\text{进程节点} & \rightarrow & \text{资源节点} \\
(P_i) & \xrightarrow{\text{请求边}} & (R_j) \\
& \xleftarrow{\text{分配边}} &
\end{array}
$$

**工作机制**：

1. 圆形节点表示进程，矩形节点表示资源类型
2. 请求边：进程 → 资源（未满足请求）
3. 分配边：资源 → 进程（已分配实例）

**系统调用**：

- `pthread_mutex_trylock()`（非阻塞资源请求）
- `getrusage()`（监控资源使用）

**Linux 命令**：

```bash
# 查看进程资源锁状态
lsof -p <PID> | grep -E 'LOCK|REG'
```

---

### 知识点 2：死锁检测算法 [算法实现]

**伪代码实现**：

```python
def detect_deadlock(processes):
    work = set(processes)
    while work:
        found = False
        for p in work:
            if p.can_acquire_all_resources():
                p.release_all_resources()
                work.remove(p)
                found = True
                break
        if not found:  # 存在不可简化的进程
            return True
    return False
```

**复杂度分析**：

- 时间：O(n²)（最坏情况需 n 轮遍历，每轮检查 n 个进程）
- 空间：O(n+k)（n 个进程，k 种资源类型）

---

### 知识点 3：解除方法对比 [策略选择]

| 方法       | 优点             | 缺点                 | 适用场景       |
| ---------- | ---------------- | -------------------- | -------------- |
| 资源剥夺法 | 保留进程上下文   | 可能引发饥饿         | 长事务处理系统 |
| 撤销进程法 | 立即释放所有资源 | 丢失未保存工作       | 批处理系统     |
| 进程回退法 | 避免重复计算     | 需要完善的检查点机制 | 数据库管理系统 |

**现实类比**：

> 交通管制中的死锁解除：
>
> - 资源剥夺 = 让部分车辆倒车让路
> - 撤销进程 = 拖走特定车辆
> - 回退法 = 所有车辆回到路口前状态

---

## 总结区

### 核心考点

1. **资源分配图简化步骤**（必须能手工推导）
2. **检测算法时间复杂度**（常考选择题计算题）
3. **解除策略对比**（简答题高频考点）

### 实验提示

```bash
# 死锁现象复现（需内核4.1+）
#!/bin/bash
deadlock_sim() {
    mutex_A=$(mktemp); mutex_B=$(mktemp)
    (flock $mutex_A sleep 5; flock $mutex_B) &
    (flock $mutex_B sleep 5; flock $mutex_A) &
    wait
}
deadlock_sim
```

**关键参数**：

- **EXT4 文件系统最大 inode 数 4,294,967,295**
- **Linux 默认最大进程数 32768**（`pid_max`参数）

---

通过本课掌握死锁处理的核心方法论，注意实验环节中资源监控命令的使用场景，考试重点在于算法流程的手动推导和解除策略的对比分析。
