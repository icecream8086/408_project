# Context

进程的**上下文（Context）**和**PCB（Process Control Block，进程控制块）**是密切相关的概念，但它们的含义和用途有所不同。下面用通俗易懂的方式解释它们的区别和联系：

---

## **1. 进程上下文（Context）**

### **定义**

进程的上下文是指**进程在 CPU 上执行时所需的全部状态信息**。当操作系统需要切换进程时（比如时间片用完、发生中断等），必须保存当前进程的上下文，并恢复下一个进程的上下文。

### **上下文的组成**

进程上下文主要包括两部分：

1. **用户级上下文**
   - 进程的代码、数据、堆栈（用户空间的内存）。
   - 例如：程序计数器（PC）、寄存器值、变量状态等。
2. **内核级上下文**
   - 进程在内核态运行时的状态（如系统调用时的内核栈、CPU 寄存器等）。

### **为什么需要保存上下文？**

- **进程切换时**：CPU 需要保存当前进程的状态，以便下次恢复执行。
- **中断处理时**：比如硬件中断（键盘输入、时钟中断）发生时，需要保存当前进程状态，处理完后再恢复。

### **示例**

假设进程 A 正在运行，此时发生时钟中断，OS 决定切换到进程 B：

1. **保存进程 A 的上下文**（寄存器值、PC、栈指针等）。
2. **加载进程 B 的上下文**（恢复它的寄存器、PC 等）。
3. **CPU 开始执行进程 B**。

---

## **2. PCB（Process Control Block）**

### **定义1**

PCB 是操作系统内核中用于**管理进程的数据结构**，每个进程都有一个对应的 PCB。它存储了进程的所有关键信息，是进程存在的唯一标识。

### **PCB 的典型内容**

| **类别**     | **存储的信息**                           |
| ------------ | ---------------------------------------- |
| **进程标识** | PID（进程 ID）、PPID（父进程 ID）        |
| **状态信息** | 运行态、就绪态、阻塞态等                 |
| **CPU 状态** | 寄存器值、程序计数器（PC）、栈指针（SP） |
| **内存管理** | 页表、内存分配信息                       |
| **文件/IO**  | 打开的文件描述符、IO 设备状态            |
| **调度信息** | 优先级、时间片剩余量                     |

### **PCB 的作用**

- **进程的唯一代表**：操作系统通过 PCB 管理进程。
- **上下文切换的基础**：保存的上下文信息就存储在 PCB 中。
- **资源管理的依据**：通过 PCB 知道进程占用了哪些资源（如内存、文件）。

---

## **3. 上下文 vs PCB 的关系**

- **上下文**是**PCB 的一部分**：PCB 存储了进程的上下文（如寄存器、PC 等），但还包含其他管理信息（如 PID、文件描述符等）。
- **上下文切换依赖 PCB**：
  - 切换进程时，OS 从 PCB 中恢复目标进程的上下文（如寄存器值）。
  - 当前进程的上下文会被保存到它的 PCB 中。

### **类比**

- **PCB ≈ 护照**（包含你的身份信息、签证记录等）。
- **上下文 ≈ 你当前的旅行状态**（如所在城市、行李内容、机票信息）。
  - 当你切换国家（进程切换）时，需要记录当前状态（保存上下文），并恢复目标国家的状态（从 PCB 加载上下文）。

---

## **4. 总结**

| **概念**   | **作用**                | **包含内容**                   |
| ---------- | ----------------------- | ------------------------------ |
| **上下文** | 进程在 CPU 上的瞬时状态 | 寄存器、PC、栈指针等运行时数据 |
| **PCB**    | 进程的全局管理结构      | PID、状态、上下文、资源占用等  |

- **进程切换时**：

  1. 保存当前进程的**上下文**到它的 PCB。
  2. 从目标进程的 PCB 加载**上下文**到 CPU。
  3. 执行目标进程。

- **PCB 是持久的**（只要进程存在，PCB 就存在），而**上下文是瞬时的**（仅代表某一时刻的 CPU 状态）。

---

### **面试常见问题**

1. **Q**：上下文切换（Context Switch）的开销来自哪里？  
   **A**：主要是保存/恢复寄存器、刷新 CPU 缓存（Cache）、更新页表（TLB 失效）等。

2. **Q**：PCB 存储在内存的哪个区域？  
   **A**：内核空间（用户进程无法直接访问）。

3. **Q**：线程有 PCB 吗？  
   **A**：轻量级线程（如 Linux 的 pthread）共享进程的 PCB，但会有独立的线程控制块（TCB）。
