# 磁盘管理

## 摘要

本笔记系统化解析磁盘管理的三大核心组件：磁盘初始化流程、引导块工作机制及坏块管理策略。重点剖析低级格式化数据结构、自举程序加载时序逻辑、以及坏块替换算法实现原理。

## 主题

磁盘存储系统的物理-逻辑映射架构，涵盖初始化过程、启动引导机制和容错管理方案。关键技术点包括扇区数据布局、文件系统元数据结构、备用扇区替换算法。

> 重点难点
>
> - **物理格式化与逻辑格式化的层次关系**
> - **自举程序的双阶段加载机制**
> - **基于控制器的坏块热替换实现原理**

## 线索区

### 1. 磁盘初始化

**定义**：将物理磁盘转换为可存储数据的逻辑设备的三阶段过程  
**技术规范**（IEEE Std 1244）：

1. **低级格式化**
   - 物理扇区构建：`[头同步码 | 数据区(512B) | 纠错码(ECC)]`
   - 扇区间隔(Intersector Gap)：典型值**200ns**
2. **磁盘分区**
   - 分区表结构：MBR/GPT 格式
   - 柱面对齐优化：降低**寻道延迟**
3. **逻辑格式化**
   - 文件系统元数据：

     ```text
     SuperBlock = {inode_count, block_size, free_list}
     ```

   - 目录项结构：`[文件名 hash(32bit) | inode指针(64bit)]`

### 2. 引导块

**定义**：存储自举程序(Bootstrap Loader)的保留扇区  
**加载流程**：

1. BIOS 读取 ROM 中**512B**引导程序
2. 定位磁盘**0 柱面 0 磁头 1 扇区**(MBR)
3. 加载 OS 内核至内存**0x7C00**地址  
   **关键参数**：

- 引导签名：**0x55AA**（MBR 有效性标识）
- 加载时限：**5 秒**超时机制

### 3. 坏块管理

**技术演进**：  

| 方案类型 | 实现机制 | 典型应用 |
|---------|--------|---------|
| 软件标记 | FAT 表置**0xFFF7**标记 | MS-DOS |
| 硬件替换 | 维护**P-list/G-list**缺陷表 | SCSI 磁盘 |

**替换算法流程**：

1. 磁盘控制器检测 ECC 错误
2. 将坏块映射到备用区(Spare Sector)
3. 更新 G-list 并重定向 I/O 请求  
   **性能指标**：

- 备用块占比：**0.1%-1%**总容量
- 替换延迟：**<1ms**（控制器级处理）

## 总结区

**知识拓扑**：  
初始化(物理 → 逻辑) → 引导(固件 → 系统) → 容错(检测 → 修复)

**考点解析**：

1. 分区对齐对 IOPS 的影响计算
2. 双阶段引导过程与系统安全漏洞的关联
3. 比较 FAT 标记与控制器替换方案的可靠性差异

**工程实践**：

- 使用`fdisk -l`查看分区对齐状态
- 通过`smartctl -t long /dev/sda`触发坏块扫描
- 备用块耗尽预警阈值建议设置为**80%**

本结构强化了磁盘管理技术的实现细节与工程参数，适用于存储系统设计与操作系统开发场景。
