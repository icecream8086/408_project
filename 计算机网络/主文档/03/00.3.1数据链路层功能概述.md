# 数据链路层深度解析

## 摘要

本课程系统讲解数据链路层核心机制，通过协议帧结构解析、实验抓包验证、服务类型对比等方法，建立可验证的链路层知识体系。重点涵盖差错控制实现原理、服务类型应用场景、典型协议抓包分析技巧。

## 主题

数据链路层实现相邻节点可靠通信，核心机制包括组帧技术、差错控制算法、流量控制策略。通过协议帧结构逆向分析掌握链路层工作原理，结合 Wireshark 实验验证理论模型。

> 重点难点
>
> - 以太网帧结构各字段功能解析
> - CRC 校验算法与海明码实现差异
> - 三种服务类型的实时场景选择依据

## 线索区

### 协议帧结构（物理层/数据链路层）

\# 以太网帧结构（RFC 894）

| 目的 MAC (6B) | 源 MAC (6B) | 类型 (2B) | 数据 (46-1500B) | CRC (4B) |
| ------------- | ----------- | --------- | --------------- | -------- |

**关键参数**：

- **最小帧长 64 字节**（含 14 字节头部+4 字节 CRC）
- **MTU 1500 字节**（数据字段最大值）

\# Wireshark 过滤表达式：
`eth.addr == aa:bb:cc:dd:ee:ff && eth.type == 0x0800`

\# tcpdump 命令（Linux）：
`tcpdump -i eth0 -enn -vvv -c 5 'ether proto 0x0800'`

### 服务类型对比

| 类型           | 确认机制 | 连接管理 | 典型应用       | 抓包特征           |
| -------------- | -------- | -------- | -------------- | ------------------ |
| 无确认无连接   | ❌       | ❌       | 实时音视频     | 连续单向数据帧     |
| 有确认无连接   | ✅       | ❌       | 工业传感器网络 | 数据帧+独立 ACK 帧 |
| 有确认面向连接 | ✅       | ✅       | 金融交易系统   | 握手帧+序列号传输  |

### 差错控制机制

\# 现实类比：

- **CRC 校验**：如同快递包裹的防拆封条，检测运输过程中是否发生意外改动
- **自动重传 ARQ**：类似重要文件快递，收件人签收后自动发送回执，超时未收到则重新发送

\# 协议状态机（停等协议）：

```
[发送方]
发送帧 → 启动定时器
├─ 收到ACK → 发送下一帧
└─ 超时未确认 → 重传当前帧

[接收方]
接收帧 → CRC校验
├─ 校验通过 → 发送ACK
└─ 校验失败 → 静默丢弃
```

## 总结区

1. **核心考点**：

   - 以太网帧结构各字段长度计算（特别注意前导码不计入帧长）
   - 三种服务类型的典型应用场景选择（误码率 vs 实时性需求）

2. **实验重点**：

   - 使用`ethereal`命令生成定制以太网帧：
     `echo "test" | ethtool -E eth0 magic 0x1234 offset 0 length 5`
   - 通过`ifconfig eth0 mtu 1492`修改 MTU 值观察分片现象

3. **故障排查**：
   当出现**高丢包率**时，可通过以下命令组合诊断：

   ```bash
   ethtool -S eth0  # 查看网卡统计信息
   tcpdump -i eth0 -w error.pcap  # 捕获异常帧
   wireshark -Y "eth.type == 0x8864" error.pcap  # 分析PPPoE发现帧
   ```
