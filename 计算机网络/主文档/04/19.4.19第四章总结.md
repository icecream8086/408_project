# 网络层与IPv6过渡技术

## 摘要

本课程解析网络层核心功能与IPv6过渡机制，通过协议分析+实验验证方法，构建分层网络认知体系。重点涵盖IPv4/IPv6协议差异、地址管理策略及过渡技术实现，配套抓包验证方案。

## 主题

网络层实现异构网络互联，核心功能包含路由选择/分组转发/拥塞控制。IPv4向IPv6演进采用双协议栈/隧道技术，地址管理经历分类地址→子网划分→CIDR→NAT技术路线。

> 重点难点
> 
> - IPv4分片重组机制与首部字段映射
> - CIDR地址聚合计算方法
> - IPv6邻居发现协议与地址自动配置
> - 6to4隧道封装格式验证

## 线索区

### 知识点1: IP数据报结构（网络层）
```latex
IPv4 Header Format:
 0                   1                   2                   3   
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|Version|  IHL  |Type of Service|          Total Length         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Identification        |Flags|      Fragment Offset    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Time to Live |    Protocol   |         Header Checksum       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       Source Address                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Destination Address                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

**实验验证**：
```bash
# 查看IP分片（Linux）
tcpdump -i eth0 'ip[6:2] & 0x3fff != 0' -vv

# Wireshark过滤器
ip.flags.mf == 1 || ip.frag_offset > 0
```

### 知识点2: CIDR地址聚合（网络层）
**计算示例**：
```latex
给定地址块 192.168.1.0/24 和 192.168.2.0/24，求聚合后超网：
最大公共前缀为22位 → 192.168.0.0/22
```

**路由表压缩**：
```bash
# 查看Linux路由聚合
ip route show | grep "proto kernel"
```

### 知识点3: IPv6邻居发现（网络层）
**协议交互流程**：
1. 路由器通告（RA）：FF02::1 组播
2. 地址无状态自动配置：EUI-64生成接口ID
3. 重复地址检测（DAD）：NS/NA报文交换

**抓包技巧**：
```bash
# 捕获IPv6 ND报文
tshark -i eth0 'icmpv6.type == 133 || icmpv6.type == 134'
```

### 知识点4: 6to4隧道（网络层）
**封装结构**：
```latex
| IPv4 Header (Protocol=41) | IPv6 Header | Payload |
```

**隧道配置验证**：
```bash
# Linux配置6to4隧道
ip tunnel add sit1 mode sit remote 192.0.2.1 local 203.0.113.2
ip link set sit1 up
ip -6 addr add 2002:cb00:71ff::1/16 dev sit1

# 抓取隧道流量
tcpdump -i sit0 -nn 'ip proto 41'
```

## 总结区

**核心考点**：
1. IPv4分片字段计算（标志位MF/DF + 片偏移量）
2. CIDR地址聚合的二进制位操作
3. IPv6地址生命周期管理（临时地址 vs 稳定地址）
4. 隧道技术选型场景对比（6to4 vs Teredo vs ISATAP）

**实验重点**：
- 使用Wireshark分析IPv6 RA报文中的**前缀信息选项**
- 验证NAT64转换过程中的**协议转换痕迹**
- 对比双协议栈环境下DNS查询的**AAAA记录优先级**

**性能参数**：
- **IPv6最小MTU 1280字节**
- 6to4中继路由器地址 192.88.99.1
- Teredo服务器默认端口 **3544/UDP**