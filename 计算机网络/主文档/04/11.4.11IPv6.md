# IPv6与IPv4协议解析

## 摘要

本课程通过对比分析IPv6与IPv4协议差异，系统阐述IPv6地址表示方法、地址类型及兼容策略。结合协议栈分层验证方法，提供可抓包验证的实验方案，解决地址压缩机制理解、协议字段变更验证等核心难点。

## 主题

IPv6协议特性演进路径与实现验证要点，包含头部结构对比、地址表示规范、通信模式转型三大维度。

> 重点难点
> 
> - **协议头精简验证**：IPv6删除校验和字段对传输层的影响
> - **零压缩歧义规避**：2001:0db8::1与2001:db8:0::1等价性证明
> - **任播溯源难题**：任播地址在故障排查中的特殊表现
> - **隧道封装检测**：IPv6-in-IPv4封装报文识别方法

---

## 线索区

### 物理层/传输层联动验证
```latex
% IPv4与IPv6头部对比（单位：bit）
\begin{tabular}{|c|c|c|}
\hline
\textbf{字段} & \textbf{IPv4} & \textbf{IPv6} \\
\hline
版本 & 4(4) & 6(4) \\
头部长度 & IHL(4) & 固定40B \\
服务类型 & ToS(8) & 流量类别(8) \\
流标签 & - & Flow Label(20) \\
生存时间 & TTL(8) & Hop Limit(8) \\
协议 & Protocol(8) & Next Header(8) \\
校验和 & Header Checksum(16) & 无 \\
\hline
\end{tabular}
```

**实验验证命令**：
```bash
# Linux查看IPv6邻居缓存（网络层）
ip -6 neigh show
# Windows抓取IPv6路由表（网络层）
netsh interface ipv6 show route
# Wireshark过滤IPv6扩展头（传输层）
ipv6.hopopts or ipv6.dstopts or ipv6.routing
```

### 地址表示规范
**零压缩规则**：
1. 前导零省略：2001:**0**db8 → 2001:db8
2. 连续零组压缩：2001:0000:0000:0001 → 2001::1
3. 双冒号单现原则：非法地址示例 fe80::1234::1

**地址类型识别表**：
| 地址前缀 | 类型   | 通信模式      | 抓包特征              |
|----------|--------|---------------|-----------------------|
| 2000::/3 | 单播   | 端到端        | 明确源/目的地址       |
| FF00::/8 | 多播   | 一组所有节点  | 目的地址为多播组      |
| ::/96    | 兼容地址| IPv4映射通信  | 低32位包含IPv4地址    |

### 协议兼容机制
**双协议栈流量特征**：
```wireshark-filter
# 捕获双栈环境DNS查询
dns.qry.type == AAAA or dns.qry.type == A
```

**6to4隧道报文结构**：
```
[IPv4 Header][Protocol=41]
└── [IPv6 Header]
    └── [TCP/UDP Payload]
```

**隧道检测命令**：
```bash
# Linux查看隧道接口（链路层）
ip -d link show dev sit1
# tcpdump捕获隧道流量（需root权限）
tcpdump -ni eth0 'ip proto 41' -vv
```

---

## 总结区

### 协议演进验证要点
1. **头部精简**：IPv6移除校验和后需通过TCP/UDP校验保障数据完整性
2. **地址扩展**：/64子网前缀支持 SLAAC 无状态地址配置
3. **兼容过渡**：双协议栈需同步维护 IPv4/v6 路由表

### 故障排查场景
- **案例1**：IPv6多播流量丢失 → 检查`ff02::1`地址过滤规则
- **案例2**：隧道建立失败 → 验证IPv4承载网是否放行协议号41
- **案例3**：零压缩歧义 → 使用`ipv6calc`工具标准化地址格式

### 性能参数备忘录
- **最小MTU**：IPv6要求链路层支持**1280字节**MTU
- **邻居发现**：NS/NA报文默认周期**30秒**
- 流标签字段：支持**2^20**个并行数据流

> 下一阶段建议：通过Wireshark对比分析TCP over IPv6与IPv4的吞吐量差异，观察QoS字段对流量调度的影响。