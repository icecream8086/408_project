# 计算机网络分层结构

## 摘要

本课程解析计算机网络分层结构的核心原理，通过**协议栈分层模型**将复杂通信问题模块化。重点阐述各层功能定义、数据单元交互机制及分层设计原则，提供可验证的抓包实验方法，实现从理论到实践的闭环验证。

---

## 主题

网络分层架构通过**协议/接口/服务**三要素实现功能解耦，核心解决**跨设备协同**与**异构系统互通**问题。关键设计原则体现为**服务单向性**与**接口标准化**。

> **重点难点**
>
> - 协议数据单元(PDU)与接口服务单元(SDU)的转换关系
> - 分层结构中**垂直服务调用**与**水平协议交互**的差异
> - VLAN 标签在数据链路层的**透明传输机制**

---

## 线索区

### 分层架构实现原理

$$
% 数据封装过程公式化表达
PDU_n = SDU_{n+1} + PCI_n
$$

- **协议栈穿透实验**：

  ```bash
  # 观察HTTP-TCP-IP-Ethernet封装过程
  tcpdump -i eth0 -nnv 'tcp port 80' -w http.pcap
  ```

- **Wireshark 过滤**：  
  `frame.number == 1 && http` 显示首个 HTTP 请求的完整协议栈

### 数据单元交互机制

| 层级       | PDU 名称   | 关键字段             | 典型长度 |
| ---------- | ---------- | -------------------- | -------- |
| 应用层     | Message    | HTTP Header/Body     | 可变     |
| 传输层     | Segment    | **源端口**、窗口大小 | ≤65,535B |
| 网络层     | Packet     | TTL、**分片标识**    | ≤65,535B |
| 数据链路层 | Frame      | **MAC 地址**、FCS    | 64-1518B |
| 物理层     | Bit Stream | 前导码、曼彻斯特编码 | -        |

### 分层设计验证实验

**实验目标**：验证 TCP 重传机制与 IP 分片的关系

```bash
# Linux环境模拟MTU限制
sudo ifconfig eth0 mtu 500
# 触发TCP分段
curl http://testserver/largefile.zip
# 抓包分析
tshark -r trace.pcap -Y "tcp.analysis.retransmission || ip.flags.mf"
```

---

## 总结区

**核心考点**：

1. 协议栈封装过程中**PCI 添加顺序**（自上而下递增）
2. **MTU 与 MSS 的制约关系**：
   - 以太网 MTU=1500 → TCP MSS=1460（扣除 IP/TCP 头）
3. **故障诊断线索**：
   - CRC 错误 → 物理层问题
   - ARP 超时 → 数据链路层地址解析失败

**进阶思考**：  
当 VXLAN 隧道封装导致 MTU 超限时，如何通过**DF 位检测**与**PMTUD 机制**定位问题？

> **实验延伸**：使用 Scapy 构造带**DF 标志**的 ICMP 探测包，观察路径 MTU 发现过程
>
> ```python
> from scapy.all import *
> send(IP(dst="8.8.8.8", flags="DF")/ICMP()/("X"*1472))
> ```

通过该结构化笔记，学习者可快速构建分层协议分析框架，并掌握抓包验证的关键技术点。
